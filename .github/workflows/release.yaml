name: Build and Release Flutter App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write      # for creating release + tag
  packages: write     # if you ever publish packages

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # needed for proper versioning if you use git tags in app

      # ------------------------------------------------------------------
      # 1. Java + Flutter setup
      # ------------------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.6
          channel: stable
          cache: true

      # ------------------------------------------------------------------
      # 2. Cache pub dependencies (huge time saver)
      # ------------------------------------------------------------------
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/package_config.json
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-pub-

      # ------------------------------------------------------------------
      # 3. Install Android SDK + NDK upfront (prevents random cancelations)
      # ------------------------------------------------------------------
      - name: Install Android SDK & NDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-34
            build-tools;34.0.0
            ndk;27.0.12077973
            accept-licenses: true

      # Optional: cache the huge NDK between runs (saves 5–10 min)
      - name: Cache NDK
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_HOME }}/ndk/27.0.12077973
          key: ndk-27.0.12077973-${{ runner.os }}

      # ------------------------------------------------------------------
      # 4. Create .env file from secrets
      # ------------------------------------------------------------------
      - name: Create .env file
        run: |
          cat <<EOF > .env
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          WEB_CLIENT_ID=${{ secrets.WEB_CLIENT_ID }}
          ANDROID_CLIENT_ID=${{ secrets.ANDROID_CLIENT_ID }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          EOF

      - name: Flutter pub get
        run: flutter pub get

      # ------------------------------------------------------------------
      # 5. Decode signing keystore (only for AAB)
      # ------------------------------------------------------------------
      - name: Decode Android keystore
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/key.jks
          cat <<EOF > android/key.properties
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=../app/key.jks
          EOF

      # ------------------------------------------------------------------
      # 6. Build both APK (split) + AAB in parallel inside the same job
      # ------------------------------------------------------------------
      - name: Build Release APK (split per ABI)
        run: flutter build apk --release --split-per-abi

      - name: Build Release App Bundle (AAB)
        run: flutter build appbundle --release

      # ------------------------------------------------------------------
      # 7. Upload artifacts
      # ------------------------------------------------------------------
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: appbundle-release
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  # ----------------------------------------------------------------------
  # 8. Create GitHub Release (only on real tags)
  # ----------------------------------------------------------------------
  create-release:
    needs: build-android
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find . -name "*.apk" -o -name "*.aab" | xargs -I {} cp {} release-assets/
          ls -la release-assets/

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: "قفل بان ${{ github.ref_name }}"
          body: |
            قفل بان منتشر شد!

            دانلود برای اندروید:
            • فایل AAB (برای گوگل پلی و مایکت)
            • APKهای جدا شده برای ABIهای مختلف (arm64-v8a, armeabi-v7a, x86_64)

            تغییرات نسخه:
            - بهبود عملکرد
            - رفع باگ های جزئی
            - اضافه شدن ویژگی جدید
          artifacts: "release-assets/*"
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Upload to Cafe Bazaar
      #   uses: matinzd/cafebazaar-release@v1
      #   with:
      #     cafebazaar-pishkhaan-api-secret: ${{ secrets.CAFEBAZAAR_API_SECRET }}
      #     app_file: release-assets/app-release.aab
      #     auto_publish: true
      #     changelog_fa: |
      #       نسخه ${{ github.ref_name }}
      #       • بهبود امنیت لاگین
      #       • بهینه سازی همگام سازی
      #       • رفع باگ های گزارش شده