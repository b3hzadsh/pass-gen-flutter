name: Build and Release Flutter App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - build-type: apk
            artifact-name: apk-files
            output-path: build/app/outputs/flutter-apk/
          - build-type: appbundle
            artifact-name: app-bundle
            output-path: build/app/outputs/bundle/release/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.6
          channel: stable

      - name: Create .env
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "WEB_CLIENT_ID=${{ secrets.WEB_CLIENT_ID }}" >> .env
          echo "ANDROID_CLIENT_ID=${{ secrets.ANDROID_CLIENT_ID }}" >> .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: Get dependencies
        run: flutter pub get

      - name: Decode Keystore
        if: matrix.build-type == 'appbundle'  # فقط برای AAB نیازه
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          mkdir -p android/app
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/key.jks
          cat <<EOF > android/key.properties
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=key.jks
          EOF

      - name: Build APK (split per ABI)
        if: matrix.build-type == 'apk'
        run: flutter build apk --release --split-per-abi

      - name: Build App Bundle
        if: matrix.build-type == 'appbundle'
        run: flutter build appbundle --release

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.output-path }}
          retention-days: 30

  create-release:
    needs: build-android
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: apk-files
          path: apk-artifacts

      - name: Download AAB artifacts
        uses: actions/download-artifact@v4
        with:
          name: app-bundle
          path: aab-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp apk-artifacts/* release-assets/ 2>/dev/null || true
          cp aab-artifacts/* release-assets/ 2>/dev/null || true
          ls -la release-assets/

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: "قفل بان ${{ github.ref_name }}"
          body: |
            قفل بان منتشر شد!

            دانلود برای اندروید:
            • فایل AAB (برای گوگل پلی و مایکت)
            • APKهای جدا شده برای ABIهای مختلف (arm64-v8a, armeabi-v7a, x86_64)

            تغییرات نسخه:
            - بهبود عملکرد
            - رفع باگ های جزئی
            - اضافه شدن ویژگی جدید
          artifacts: "release-assets/*"
          token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Upload to Cafe Bazaar
      #   uses: matinzd/cafebazaar-release@v1
      #   with:
      #     cafebazaar-pishkhaan-api-secret: ${{ secrets.CAFEBAZAAR_API_SECRET }}
      #     app_file: release-assets/app-release.aab
      #     auto_publish: true
      #     changelog_fa: |
      #       نسخه ${{ github.ref_name }}
      #       • بهبود امنیت لاگین
      #       • بهینه سازی همگام سازی
      #       • رفع باگ های گزارش شده